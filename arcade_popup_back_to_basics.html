<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Arcade + Pop-Up Previewer (Back to Basics)</title>
  <style>
    body {font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;margin:0;padding:0;background:#f5f5f7;color:#1d1d1f;}
    header {background:#000;color:#fff;padding:15px;text-align:center;font-size:1.4em;font-weight:600;}
    section {padding:20px;background:#fff;margin:10px;border-radius:6px;box-shadow:0 2px 4px rgba(0,0,0,0.1);}
    h3 {margin-top:0;}
    textarea {width:100%;border:1px solid #d2d2d7;border-radius:6px;padding:6px;font-family:monospace;font-size:14px;}
    button {background:#0071e3;color:#fff;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;}
    button:hover {background:#0077ed;}
    .snippet, .field-item, .template-item, .export-box, .arcade-debug, .popup-preview, .default-popup {margin-top:10px;background:#f9f9fb;border:1px solid #e5e5ea;border-radius:6px;padding:8px;}
    .popup-table {width:100%;border-collapse:collapse;}
    .popup-table td {border:1px solid #e5e5ea;padding:4px 6px;font-size:12px;}
    .debug-line{font-family:monospace;font-size:12px;padding:2px 4px;border-bottom:1px solid #f0f0f0;}
    .debug-error{background:#fff3f3;color:#a71d2a;}
    .debug-success{background:#f3fff3;color:#1a7a1a;}
    h4{margin-bottom:4px;}
  </style>
</head>
<body>
<header>Arcade + Pop-Up Previewer (Back to Basics)</header>

<section>
  <h3>1. Load Feature Service</h3>
  <input type="text" id="fsUrl" placeholder="Enter REST endpoint URL (e.g., https://.../FeatureServer/0)" style="width:80%;padding:6px;">
  <button onclick="loadLayer()">Load Layer</button>
  <div id="layerStatus"></div>
  <div class="default-popup" id="defaultPopup"></div>
</section>

<section>
  <h3>2. Snippets Library</h3>
  <textarea id="arcadeInput" placeholder="Write or paste Arcade expression here..."></textarea>
  <div id="snippetsList"></div>
</section>

<section>
  <h3>3. Pop-Up Builder</h3>
  <div id="fieldList"></div>
  <button onclick="togglePopupPreview()">Show Pop-Up Preview</button>
  <div class="popup-preview">
    <div class="popup-title" id="popupTitle">Sample Title</div>
    <div class="popup-subtitle" id="popupSubtitle">Sample Subtitle</div>
    <table class="popup-table" id="popupTable"></table>
  </div>
</section>

<section>
  <h3>4. Debugger</h3>
  <textarea id="debugInput" placeholder="Enter Arcade expression..."></textarea>
  <button onclick="runDebugger()">Run Debugger</button>
  <div class="arcade-debug" id="arcadeDebug"></div>
</section>

<section>
  <h3>5. Templates & Export</h3>
  <div id="templateList"></div>
  <div class="popup-preview">
    <div class="popup-title" id="templateTitle">Sample Title</div>
    <div class="popup-subtitle" id="templateSubtitle">Sample Subtitle</div>
    <table class="popup-table" id="templateTable"></table>
  </div>
  <div class="export-box">
    <label><input type="radio" name="exportMode" value="arcade" checked> Arcade Expression</label><br>
    <label><input type="radio" name="exportMode" value="html"> Raw HTML</label>
    <textarea id="exportOutput" readonly></textarea>
    <button onclick="generateExport()">Generate Export</button>
    <button onclick="copyExport()">Copy to Clipboard</button>
  </div>
  <div class="popup-preview" id="exportPreview"></div>
</section>

<script>
let fieldMeta=[], sampleFeature={}, lastTemplate={code:""};

// Load Layer (unchanged logic from working version)
async function loadLayer(){
  const url=document.getElementById('fsUrl').value.trim();
  document.getElementById('layerStatus').innerText='';
  document.getElementById('defaultPopup').innerHTML='';
  if(!url){document.getElementById('layerStatus').innerText='Enter a valid URL';return;}
  document.getElementById('layerStatus').innerText='Loading...';
  try{
    const res=await fetch(url+(url.includes('?')?'&':'?')+"where=1=1&outFields=*&returnGeometry=false&resultRecordCount=1&f=json");
    const data=await res.json();
    fieldMeta=data.fields.map(f=>({name:f.name,display:'text'}));
    sampleFeature=data.features[0].attributes;
    document.getElementById('layerStatus').innerText=`Loaded ${fieldMeta.length} fields. Sample OBJECTID: ${sampleFeature.OBJECTID||'N/A'}`;
    renderDefaultPopup();
    renderSnippets();
    renderFieldList();
    renderTemplates();
  }catch(e){
    document.getElementById('layerStatus').innerText='Error: '+e.message;
  }
}

// Default Popup (simple)
function renderDefaultPopup(){
  let html='<h4>Default Pop-Up</h4><table class="popup-table">';
  fieldMeta.forEach(f=>{
    html+=`<tr><td><b>${f.name}</b></td><td>${sampleFeature[f.name]||''}</td></tr>`;
  });
  html+='</table>';
  document.getElementById('defaultPopup').innerHTML=html;
}

// Snippets
function renderSnippets(){
  const container=document.getElementById('snippetsList');
  container.innerHTML='<h4>Arcade Utilities</h4>';
  const utilities=[
    {name:"Round",code:"Round($feature.FIELDNAME, 2)"},
    {name:"Uppercase",code:"Upper($feature.FIELDNAME)"},
    {name:"Currency",code:"'$' + Text($feature.FIELDNAME, '#,###')"},
    {name:"Percent",code:"Text($feature.FIELDNAME * 100, '#,###') + '%'"},
    {name:"Emoji Status",code:"When($feature.FIELDNAME > 1000, 'ðŸ”¥', 'âœ…')"},
    {name:"Google Maps",code:"'<a href="https://www.google.com/maps?q=' + $feature.Y + ',' + $feature.X + '">View</a>'"}
  ];
  utilities.forEach(s=>{
    container.innerHTML+=`<div class='snippet'><b>${s.name}</b><br><code>${s.code}</code><br><button onclick="insertSnippet('${s.code.replace(/'/g,"\\'")}')">Insert</button></div>`;
  });
  container.innerHTML+='<h4>Layer Fields</h4>';
  fieldMeta.forEach(f=>{
    const code=`$feature.${f.name}`;
    container.innerHTML+=`<div class='snippet'><b>${f.name}</b><br><code>${code}</code><br><button onclick="insertSnippet('${code}')">Insert</button></div>`;
  });
}
function insertSnippet(snippet){
  const ta=document.getElementById('arcadeInput');
  ta.value+=(ta.value?"\n":"")+snippet;
}

// Pop-Up Builder
function renderFieldList(){
  const list=document.getElementById('fieldList');
  list.innerHTML='';
  fieldMeta.forEach((f,i)=>{
    list.innerHTML+=`<div class='field-item'><span>${f.name}</span>
    <select onchange='updateDisplay(${i}, this.value)'>
      <option value='text' ${f.display==='text'?'selected':''}>Text</option>
      <option value='bold' ${f.display==='bold'?'selected':''}>Bold</option>
      <option value='html' ${f.display==='html'?'selected':''}>HTML</option>
      <option value='image' ${f.display==='image'?'selected':''}>Image</option>
    </select></div>`;
  });
}
function updateDisplay(index,val){fieldMeta[index].display=val;}
function togglePopupPreview(){
  const popupTable=document.getElementById('popupTable');
  popupTable.innerHTML='';
  fieldMeta.forEach(f=>{
    let val=sampleFeature[f.name]||'';
    if(f.display==='bold')val=`<b>${val}</b>`;
    if(f.display==='html')val=`<span style='color:blue'>${val}</span>`;
    if(f.display==='image')val=`<img src='${val}' width='50'>`;
    popupTable.innerHTML+=`<tr><td><b>${f.name}</b></td><td>${val}</td></tr>`;
  });
}

// Debugger
function runDebugger(){
  const code=document.getElementById('debugInput').value.trim();
  const debugBox=document.getElementById('arcadeDebug');
  debugBox.innerHTML='';
  if(!code){debugBox.innerHTML='<div class="debug-line debug-error">No code entered.</div>';return;}
  const lines=code.split(/\n/);
  lines.forEach((line,i)=>{
    try{
      let parsed=line;
      Object.keys(sampleFeature).forEach(k=>{
        parsed=parsed.replaceAll(`$feature.${k}`,JSON.stringify(sampleFeature[k]));
      });
      let result=eval(parsed);
      debugBox.innerHTML+=`<div class='debug-line debug-success'>Line ${i+1}: ${result}</div>`;
    }catch(e){
      debugBox.innerHTML+=`<div class='debug-line debug-error'>Line ${i+1} Error: ${e.message}</div>`;
    }
  });
}

// Templates (basic set only)
function renderTemplates(){
  const list=document.getElementById('templateList');
  list.innerHTML='';
  if(!fieldMeta.length)return;
  const templates=[
    {name:"Basic Summary",desc:"First 3 fields",code:fieldMeta.slice(0,3).map(f=>`<b>${f.name}:</b> ${sampleFeature[f.name]||''}`).join('<br>')},
    {name:"All Fields Table",desc:"All fields in one table",code:fieldMeta.map(f=>`<b>${f.name}:</b> ${sampleFeature[f.name]||''}`).join('<br>')}
  ];
  templates.forEach((t,i)=>{
    list.innerHTML+=`<div class='template-item'><b>${t.name}</b><br><small>${t.desc}</small><br><button onclick='applyTemplate(${i})'>Apply</button></div>`;
  });
  window._templates=templates;
}
function applyTemplate(index){
  const t=window._templates[index];
  lastTemplate=t;
  document.getElementById('templateTitle').innerText=t.name;
  document.getElementById('templateSubtitle').innerText=t.desc;
  document.getElementById('templateTable').innerHTML=`<tr><td colspan='2'>${t.code}</td></tr>`;
}

// Export
function generateExport(){
  const mode=document.querySelector('input[name="exportMode"]:checked').value;
  const output=document.getElementById('exportOutput');
  if(mode==='arcade'){
    output.value=`return \"${lastTemplate.code.replace(/"/g,'\\\"')}\\";`;
  }else{
    output.value=lastTemplate.code;
  }
  document.getElementById('exportPreview').innerHTML=lastTemplate.code;
}
function copyExport(){
  navigator.clipboard.writeText(document.getElementById('exportOutput').value).then(()=>alert('Copied!'));
}
</script>
</body>
</html>
